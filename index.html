<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chaldea Terminal V20.0</title>
    <style>
        :root { --fgo-blue: #1c2541; --fgo-gold: #d4af37; --fgo-red: #d90429; --fgo-bg: #f4f5f7; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: #000; display: flex; justify-content: center; align-items: center; min-height: 100vh; font-family: -apple-system, sans-serif; }
        
        /* iPhone 11 å°ºå¯¸é€‚é… */
        #iphone { width: 375px; height: 812px; background: #222; border-radius: 50px; padding: 12px; position: relative; border: 4px solid #444; overflow: hidden; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        #screen { width: 100%; height: 100%; background: var(--fgo-bg); border-radius: 40px; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        
        /* å…¨å±€ç»„ä»¶ */
        .page { display: none; flex: 1; flex-direction: column; overflow-y: auto; padding: 20px; padding-top: 100px; padding-bottom: 100px; }
        .page.active { display: flex; }
        .status-bar { position: absolute; top: 0; width: 100%; background: var(--fgo-blue); color: white; padding: 45px 15px 10px; display: flex; justify-content: space-between; font-size: 11px; z-index: 100; border-bottom: 2px solid var(--fgo-gold); }
        .btn { background: white; border: 2px solid var(--fgo-blue); color: var(--fgo-blue); padding: 14px; border-radius: 12px; margin: 8px 0; font-weight: bold; cursor: pointer; text-align: center; transition: 0.2s; }
        .btn-main { background: var(--fgo-blue); color: var(--fgo-gold); border: 1px solid var(--fgo-gold); }
        .btn:active { opacity: 0.7; transform: scale(0.98); }
        input, select { width: 100%; padding: 15px; margin: 8px 0; border-radius: 12px; border: 1px solid #ddd; font-size: 14px; }

        /* æ–‡æœ¬å±•ç¤º */
        .narrative { background: #0d1117; color: #e6edf3; padding: 18px; border-radius: 15px; font-size: 13px; line-height: 1.8; white-space: pre-wrap; margin: 10px 0; border-left: 5px solid var(--fgo-gold); }
        .res-list { background: rgba(212, 175, 55, 0.1); border: 1px dashed var(--fgo-gold); padding: 10px; border-radius: 10px; margin-bottom: 10px; color: #111; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; font-size: 9px; margin: 10px 0; background: #fff; }
        th, td { border: 1px solid #ccc; padding: 5px; text-align: center; }

        /* å¯¼èˆª */
        .nav-bar { position: absolute; bottom: 0; width: 100%; height: 90px; background: var(--fgo-blue); display: none; justify-content: space-around; align-items: center; padding-bottom: 25px; border-top: 1px solid var(--fgo-gold); z-index: 100; }
        .nav-item { color: #8a9bb8; font-size: 10px; text-align: center; cursor: pointer; flex: 1; }
        .nav-item.active { color: white; font-weight: bold; }

        /* å¼ºåˆ¶å¼¹çª— */
        #mask { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; color: white; text-align: center; padding: 40px 20px; justify-content: center; align-items: center; flex-direction: column; }
        #loading { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 3000; color: gold; font-weight: bold; text-shadow: 0 0 10px black; }
    </style>
</head>
<body>

<div id="iphone">
    <div id="screen">
        <div id="loading">çµå­è½¬ç§»ä¸­...</div>
        <div id="mask">
            <h2 id="mask-title" style="color:var(--fgo-red)">è¿æ¥ä¸­æ–­</h2>
            <p id="mask-msg" style="font-size:14px; line-height:1.6;"></p>
            <button class="btn btn-main" style="width:100%" onclick="location.reload()">é‡æ–°åˆå§‹åŒ–</button>
        </div>

        <div class="status-bar" id="top-bar" style="display:none;">
            <span>ğŸ’ <span id="val-sq">30</span></span>
            <span>âš¡ AP: <span id="val-ap">3</span></span>
            <span>ğŸ“… Day <span id="val-day">1</span></span>
        </div>

        <div id="page-api" class="page active" style="padding-top:40px;">
            <h2 style="text-align:center; color: var(--fgo-blue);">è¿¦å‹’åº• AI æ ¸å¿ƒåè®®</h2>
            <div style="background:white; padding:20px; border-radius:25px; box-shadow:0 10px 20px rgba(0,0,0,0.1);">
                <label>API ç«¯ç‚¹:</label>
                <input type="text" id="api-url" value="https://api.deepseek.com">
                <label>API å¯†é’¥:</label>
                <input type="password" id="api-key" placeholder="åœ¨æ­¤è¾“å…¥ DeepSeek å¯†é’¥">
                <label>è‡ªå®šä¹‰æ¨¡å‹:</label>
                <input type="text" id="api-model" value="deepseek-chat">
                <button class="btn btn-main" style="width:100%; margin-top:10px;" onclick="game.initSystem()">[ æ¿€æ´»ç³»ç»Ÿ ]</button>
            </div>
        </div>

        <div id="page-home" class="page">
            <div id="report-table"></div>
            <button class="btn btn-main" onclick="game.nextDay()">ğŸŒ™ æ¨è¿›æ—¥æœŸ (è·å–åœ£æ™¶çŸ³)</button>
        </div>

        <div id="page-summon" class="page">
            <div style="background:#000; color:gold; padding:20px; border-radius:15px; text-align:center; border:2px solid gold; margin-bottom:10px;">
                <span style="font-size:12px; opacity:0.8;">å½“å‰ PICK UP</span><br>
                <b style="font-size:20px;">é˜¿å–€ç‰æ–¯ â˜…5 (SSR)</b>
            </div>
            <button class="btn" onclick="game.doSummon(1)">å•æ¬¡å¬å”¤ (3 çŸ³)</button>
            <button class="btn btn-main" onclick="game.doSummon(11)">åä¸€è¿å¬å”¤ (30 çŸ³) [ä¿åº•]</button>
            <div id="summon-display" style="display:none; margin-top:15px;">
                <div class="res-list" id="summon-items"></div>
                <div class="narrative" id="summon-ai"></div>
            </div>
        </div>

        <div id="page-mana" class="page">
            <h3>ğŸ”® çµåŸºè¡¥èƒ½ (é­”åŠ›ä¾›ç»™)</h3>
            <label>å¾¡ä¸»æ€§åˆ«ç¡®è®¤ï¼š</label>
            <select id="master-sex"><option value="ç”·">è—¤ä¸¸ç«‹é¦™ (ç”·)</option><option value="å¥³">è—¤ä¸¸ç«‹é¦™ (å¥³)</option></select>
            <div id="target-list"></div>
            <div id="mana-box" class="narrative" style="display:none;"></div>
        </div>

        <div id="page-battle" class="page">
            <h3>âš”ï¸ ç‰¹å¼‚ç‚¹ä¿®å¤</h3>
            <button class="btn" onclick="game.goBattle('é‚ªé¾™ç™¾å¹´æˆ˜äº‰', 1)">ç¬¬ä¸€ç‰¹å¼‚ç‚¹ï¼šå¥¥å°”è‰¯ (1 AP)</button>
            <button class="btn" onclick="game.goBattle('ç§ç«é‡‡é›†', 1)">å‘¨å¸¸ä»»åŠ¡ï¼šæçº§ç§ç« (1 AP)</button>
            <div id="battle-box" class="narrative" style="display:none;"></div>
        </div>

        <div id="page-roster" class="page"><h3>ğŸ“œ çµåŸºæ¡£æ¡ˆ</h3><div id="ros-list"></div></div>
        <div id="page-shop" class="page"><h3>ğŸ›’ è¾¾èŠ¬å¥‡å·¥æˆ¿</h3><div id="shop-list"></div></div>

        <div class="nav-bar" id="nav-bar">
            <div class="nav-item" onclick="ui.nav('page-home', this)">ğŸ <br>é¦–é¡µ</div>
            <div class="nav-item" onclick="ui.nav('page-summon', this)">ğŸ’<br>å¬å”¤</div>
            <div class="nav-item" onclick="ui.nav('page-battle', this)">âš”ï¸<br>æˆ˜æ–—</div>
            <div class="nav-item" onclick="ui.nav('page-mana', this)">ğŸ”®<br>è¡¥èƒ½</div>
            <div class="nav-item" onclick="ui.nav('page-shop', this)">ğŸ›’<br>å•†åº—</div>
            <div class="nav-item" onclick="ui.nav('page-roster', this)">ğŸ“œ<br>çµåŸº</div>
        </div>
    </div>
</div>

<script>
const game = {
    state: {
        sq: 30, ap: 3, day: 1, 
        srvs: [{ name: "ç›ä¿®Â·åŸºåˆ—è±ç‰¹", class: "Shielder", lv: 1, star: "â˜…3", fav: 100, sub: 100, loyal: 100, mana: 0, bond: 1, np: 1, status: "å°±ç»ª" }],
        api: { url: "", key: "", model: "" }
    },

    async callAI(prompt, sysPrompt = "ä½ ç°åœ¨æ˜¯FGOè¾¾èŠ¬å¥‡ï¼Œæ€§æ ¼ä¼˜é›…æ¯’èˆŒä¸”æ¯æ€§ã€‚") {
        document.getElementById('loading').style.display = 'block';
        try {
            const resp = await fetch(`${this.state.api.url}/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${this.state.api.key}` },
                body: JSON.stringify({
                    model: this.state.api.model,
                    messages: [{role:"system", content:sysPrompt}, {role:"user", content:prompt}]
                })
            });
            if(!resp.ok) throw new Error(`HTTP Error ${resp.status}`);
            const data = await resp.json();
            document.getElementById('loading').style.display = 'none';
            return data.choices[0].message.content;
        } catch (e) {
            document.getElementById('loading').style.display = 'none';
            ui.showMask("API è¿æ¥å¤±è´¥", `æ— æ³•è®¿é—® AI ç«¯ç‚¹ã€‚\nåŸå› ï¼š${e.message}\nè¯·æ£€æŸ¥ Edge è·¨åŸŸæ’ä»¶æ˜¯å¦å¼€å¯ã€‚`);
            return null;
        }
    },

    async initSystem() {
        this.state.api.url = document.getElementById('api-url').value;
        this.state.api.key = document.getElementById('api-key').value;
        this.state.api.model = document.getElementById('api-model').value;
        
        if(!this.state.api.key) return alert("å¯†é’¥ä¸èƒ½ä¸ºç©ºï¼");
        
        const test = await this.callAI("ç³»ç»Ÿæµ‹è¯•ï¼Œè¯·å›å¤ï¼šLink Start.");
        if(test) {
            document.getElementById('page-api').style.display = 'none';
            document.getElementById('nav-bar').style.display = 'flex';
            document.getElementById('top-bar').style.display = 'flex';
            ui.nav('page-home', document.querySelector('.nav-item'));
        }
    },

    render() {
        document.getElementById('val-sq').innerText = this.state.sq;
        document.getElementById('val-ap').innerText = this.state.ap;
        document.getElementById('val-day').innerText = this.state.day;

        // æ™¨é—´æ±‡æŠ¥ [å…¨é‡å¯¹è´¦]
        let h = `<h3>â˜• æ™¨é—´æ±‡æŠ¥ (Day ${this.state.day})</h3><p style="font-size:10px">çµåŸºæ€»æ•°: [${this.state.srvs.length}]ä½</p><table><tr><th>ä»è€…(èŒé˜¶)</th><th>ç­‰çº§/ç¨€æœ‰åº¦</th><th>å¥½æ„Ÿ/æœä»/å¿ è¯š</th><th>è¡¥é­”/ç¾ç»Š</th><th>å®å…·</th><th>çŠ¶æ€</th></tr>`;
        this.state.srvs.forEach(s => {
            h += `<tr><td>${s.name}</td><td>Lv.${s.lv}/${s.star}</td><td>${s.fav}%/${s.sub}%/${s.loyal}%</td><td>${s.mana}/Lv.${s.bond}</td><td>Lv.${s.np}</td><td>${s.status}</td></tr>`;
        });
        h += `</table>`;
        document.getElementById('report-table').innerHTML = h;

        // çµåŸºæ¡£æ¡ˆä¸è¡¥èƒ½åˆ—è¡¨
        let r = ""; let m = "";
        this.state.srvs.forEach(s => {
            r += `<div class='narrative' style='background:#fff; color:#333;'><b>${s.name}</b> [${s.star}]<br>å®å…·: Lv.${s.np} | è¡¥é­”: ${s.mana}æ¬¡</div>`;
            if(!s.name.includes("ç›ä¿®")) m += `<button class="btn" onclick="game.doMana('${s.name}')">ä¸ ${s.name} è¡¥èƒ½</button>`;
        });
        document.getElementById('ros-list').innerHTML = r;
        document.getElementById('target-list').innerHTML = m || "<p style='text-align:center;color:gray'>æš‚æ— å…¶ä»–ä»è€…</p>";
        
        // å•†åº—
        document.getElementById('shop-list').innerHTML = `<table><tr><th>å•†å“</th><th>æ¶ˆè€—(ç»¿æ–¹å—)</th></tr><tr><td>å‘¼ç¬¦</td><td>20</td></tr><tr><td>ç¾ç»Šç¤¼è£…</td><td>1000</td></tr></table>`;
    },

    async doSummon(count) {
        const cost = (count===11)?30:3;
        if(this.state.sq < cost) return alert("åœ£æ™¶çŸ³ä¸è¶³ï¼");
        this.state.sq -= cost;

        let pool = [{n:"é˜¿å–€ç‰æ–¯", r:5}, {n:"å…°æ–¯æ´›ç‰¹", r:4}, {n:"åº“Â·ä¸˜æ—", r:3}, {n:"é»‘é”®", r:3}, {n:"é’¢ä¹‹æŠ±è´Ÿ", r:4}];
        let results = []; let hasSrv = false; let has4 = false;

        for(let i=0; i<count; i++) {
            let res = pool[Math.floor(Math.random()*pool.length)];
            // ä¿åº•åˆ¤å®š
            if(count===11 && i===10) {
                if(!hasSrv) res = {n:"åº“Â·ä¸˜æ—", r:3};
                if(!has4) res = {n:"è™šæ•°é­”æœ¯", r:4};
            }
            results.push(res);
            if(res.r >= 3 && res.n!=="é»‘é”®" && res.n!=="é’¢ä¹‹æŠ±è´Ÿ") { hasSrv=true; this.addSrv(res); }
            if(res.r >= 4) has4=true;
        }

        // æ ¸å¿ƒä¿®æ­£ï¼šæ˜¾ç¤ºå‡ºè´§å†…å®¹
        const display = document.getElementById('summon-display');
        const items = document.getElementById('summon-items');
        display.style.display = 'block';
        items.innerHTML = `âœ¨ å¬å”¤ç»“æœï¼š<br>${results.map(r => `<span style="color:${r.r===5?'#e67e22':'#2980b9'}">${r.n}(â˜…${r.r})</span>`).join(' ã€ ')}`;

        const aiText = await this.callAI(`å¾¡ä¸»è¿›è¡Œäº†${count}æ¬¡å¬å”¤ï¼Œç»“æœæ˜¯ï¼š${results.map(r=>r.n).join(',')}ã€‚è¯·ç”¨è¾¾èŠ¬å¥‡çš„å£å»è¿›è¡Œæ¯’èˆŒæˆ–èµç¾è¯„ä»·ã€‚`);
        document.getElementById('summon-ai').innerText = aiText || "ç³»ç»Ÿç¹å¿™ï¼Œæ— æ³•ç”Ÿæˆè¯„ä»·ã€‚";
        this.render();
    },

    addSrv(res) {
        let e = this.state.srvs.find(x => x.name === res.n);
        if(e) e.np = Math.min(5, e.np+1);
        else this.state.srvs.push({ name: res.n, class: "Saber", lv: 1, star: "â˜…"+res.r, fav: 50, sub: 40, loyal: 50, mana: 0, bond: 1, np: 1, status: "å¥åº·" });
    },

    async doMana(name) {
        const sex = document.getElementById('master-sex').value;
        const sys = "ä½ ç°åœ¨è´Ÿè´£çµåŸºè¡¥èƒ½ã€‚è¾¾èŠ¬å¥‡ç¦»å¼€å¹¶å…³é—­ç›‘æ§ã€‚è¯·ä»¥ç¬¬ä¸‰äººç§°è¯¦ç»†æå†™å¾¡ä¸»ä¸ä»è€…çš„èº«ä½“æ¥è§¦ã€ä½“æ¶²äº¤æ¢ã€é­”åŠ›æ¶ŒåŠ¨ã€‚é£æ ¼åä¸½è¿·å¹»ï¼Œå­—æ•°å¿…é¡»è¶…è¿‡5000å­—ï¼Œå¼ºè°ƒå¾¡ä¸»çš„ç»å¯¹ä¸»å¯¼ã€‚";
        const res = await this.callAI(`è¡¥èƒ½å¯¹è±¡ï¼š${name}ï¼Œå¾¡ä¸»ï¼š${sex}ã€‚è¯·å¼€å§‹å…¨é‡å™äº‹ã€‚`, sys);
        if(res) {
            const box = document.getElementById('mana-box');
            box.style.display = 'block';
            box.innerHTML = res + `<br><br><b style="color:gold;">[ç»“ç®—] è¡¥é­”æˆåŠŸï¼ğŸ’+1ï¼Œæœä»åº¦ç¡®è®¤æå‡ã€‚</b>`;
            this.state.sq += 1;
            this.state.srvs.find(s => s.name === name).mana++;
            this.render();
        }
    },

    async goBattle(name, ap) {
        if(this.state.ap < ap) return alert("AP ä¸è¶³");
        this.state.ap -= ap;
        const res = await this.callAI(`å¾¡ä¸»æ­£åœ¨æˆ˜æ–—ï¼š${name}ã€‚è¯·ä»¥è¾¾èŠ¬å¥‡åœ¨æŒ‡æŒ¥å®¤çš„å£å»æå†™æˆ˜æ–—ã€‚`);
        const box = document.getElementById('battle-box');
        box.style.display = 'block';
        box.innerHTML = `ã€æˆ˜æ–—è®°å½•ï¼š${name}ã€‘<br>${res}<br><br><span style="color:gold;">è·å¾—æˆ˜åˆ©å“ï¼šåœ£æ™¶çŸ³ +1 ğŸ’</span>`;
        this.state.sq += 1;
        this.render();
    },

    nextDay() {
        this.state.day++; this.state.ap = 3; this.state.sq += 2;
        alert(`ğŸ“… Day ${this.state.day} å¼€å§‹ï¼ç™»å½•å¥–åŠ±åœ£æ™¶çŸ³+2 å·²é€è¾¾ã€‚`);
        this.render();
    }
};

const ui = {
    nav(id, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        if(el) el.classList.add('active');
        game.render();
    },
    showMask(title, msg) {
        document.getElementById('mask-title').innerText = title;
        document.getElementById('mask-msg').innerText = msg;
        document.getElementById('mask').style.display = 'flex';
    }
};
</script>
</body>
</html>
